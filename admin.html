<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carpe Diem - Painel Administrativo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Bibliotecas para exportação PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary: #000000;
            --primary-dark: #e27d18;
            --secondary: #e1680c;
            --danger: #150901;
            --warning: #f5900b;
            --info: #e49f15;
            --light: #f8fafc;
            --dark: #1e3b22;
            --gray: #da8515;
            --gray-light: #e2e8f0;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f1f5f9;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .admin-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 16px 0;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .admin-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .logo i {
            margin-right: 10px;
            font-size: 1.8rem;
        }

        .logo span {
            color: var(--secondary);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            text-decoration: none;
        }

        .btn i {
            font-size: 0.9rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--gray-light);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background-color: var(--gray);
            color: white;
        }

        .btn-logout {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn-logout:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        /* Main Panel */
        .admin-panel {
            padding: 30px 0;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .panel-header h1 {
            font-size: 2rem;
            font-weight: 700;
        }

        .panel-header h1 span {
            color: var(--primary);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* Cards */
        .admin-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .admin-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .admin-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .admin-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--primary);
        }

        .admin-card:nth-child(2)::before {
            background: var(--secondary);
        }

        .admin-card:nth-child(3)::before {
            background: var(--info);
        }

        .admin-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .admin-card:nth-child(2) i {
            color: var(--secondary);
        }

        .admin-card:nth-child(3) i {
            color: var(--info);
        }

        .admin-card h3 {
            font-size: 1rem;
            color: var(--gray);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .admin-card .number {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--dark);
        }

        /* Tables */
        .admin-tables {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .admin-table-container {
            padding: 24px;
        }

        .admin-table-container h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 1.3rem;
            color: var(--dark);
        }

        .admin-table-container h3 i {
            color: var(--primary);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: var(--light);
        }

        th {
            text-align: left;
            padding: 16px;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 1px solid var(--gray-light);
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--gray-light);
        }

        tbody tr {
            transition: var(--transition);
        }

        tbody tr:hover {
            background-color: rgba(226, 125, 24, 0.05);
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-pending {
            background-color: rgba(245, 144, 11, 0.1);
            color: var(--warning);
        }

        .status-completed {
            background-color: rgba(226, 104, 12, 0.1);
            color: var(--secondary);
        }

        .status-cancelled {
            background-color: rgba(21, 9, 1, 0.1);
            color: var(--danger);
        }

        .btn-table {
            padding: 6px 12px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: var(--transition);
        }

        .btn-table:hover {
            background-color: var(--primary-dark);
        }

        .empty-state {
            display: none;
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--gray-light);
        }

        .empty-state h4 {
            font-weight: 500;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-light);
        }

        .modal-header h3 {
            font-size: 1.5rem;
            color: var(--dark);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray);
            transition: var(--transition);
        }

        .close-modal:hover {
            color: var(--danger);
        }

        .modal-body {
            padding: 24px;
        }

        .order-details {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--gray-light);
        }

        .order-details h4 {
            margin-bottom: 15px;
            color: var(--dark);
        }

        .order-details p {
            margin-bottom: 8px;
        }

        .order-items {
            margin-bottom: 20px;
            width: 100%;
        }

        .order-total {
            text-align: right;
            font-size: 1.2rem;
            padding-top: 15px;
            border-top: 1px solid var(--gray-light);
        }

        /* Responsividade */
        @media (max-width: 1024px) {
            .admin-cards {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .admin-header .container {
                flex-direction: column;
                gap: 15px;
            }
            
            .panel-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .action-buttons {
                width: 100%;
                justify-content: flex-start;
            }
            
            .admin-cards {
                grid-template-columns: 1fr;
            }
            
            .admin-table-container {
                overflow-x: auto;
            }
            
            table {
                min-width: 700px;
            }
            
            .modal-content {
                max-height: 95vh;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 15px;
            }
            
            .panel-header h1 {
                font-size: 1.7rem;
            }
            
            .btn {
                padding: 8px 14px;
                font-size: 0.9rem;
            }
            
            .admin-card {
                padding: 20px;
            }
            
            .admin-card .number {
                font-size: 1.8rem;
            }
            
            .modal-body {
                padding: 20px;
            }
        }
    </style>
</head>
<body>

<header class="admin-header">
  <div class="container">
    <div class="logo"><i class="fa-solid fa-burger"></i> CARP<span>DIEM</span> ADMIN</div>
    <div class="user-info">
      <span>Bem-vindo, Administrador</span>
      <button class="btn btn-logout" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Sair</button>
    </div>
  </div>
</header>

<section class="admin-panel">
  <div class="container">
    <div class="panel-header">
      <h1>Painel <span>Administrativo</span></h1>
      <div class="action-buttons">
        <button class="btn btn-primary" id="refreshData"><i class="fas fa-sync-alt"></i> Atualizar Dados</button>
        <button class="btn btn-primary" id="exportData"><i class="fas fa-download"></i> Exportar Relatório</button>
        <a href="index.html" class="btn btn-secondary"><i class="fas fa-store"></i> Ver Site</a>
      </div>
    </div>

    <!-- Cards -->
    <div class="admin-cards">
      <div class="admin-card">
        <i class="fas fa-shopping-cart"></i>
        <h3>Pedidos Hoje</h3>
        <div class="number" id="todayOrders">0</div>
      </div>
      <div class="admin-card">
        <i class="fas fa-dollar-sign"></i>
        <h3>Faturamento</h3>
        <div class="number" id="todayRevenue">R$ 0,00</div>
      </div>
      <div class="admin-card">
        <i class="fas fa-users"></i>
        <h3>Clientes</h3>
        <div class="number" id="todayCustomers">0</div>
      </div>
    </div>

    <!-- Tabelas -->
    <div class="admin-tables">
      <div class="admin-table-container">
        <h3><i class="fas fa-list"></i> Últimos Pedidos</h3>
        <table id="recentOrders">
          <thead>
            <tr>
              <th>Pedido</th>
              <th>Cliente</th>
              <th>Valor</th>
              <th>Status</th>
              <th>Data</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="empty-state" id="emptyOrders">
          <i class="fas fa-clipboard-list"></i>
          <h4>Nenhum pedido realizado</h4>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Modal de detalhes -->
<div class="modal" id="orderModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Detalhes do Pedido</h3>
      <button class="close-modal" id="closeModal">&times;</button>
    </div>
    <div class="modal-body">
      <div class="order-details">
        <h4>Informações do Cliente</h4>
        <p><strong>Nome:</strong> <span id="modalClienteNome"></span></p>
        <p><strong>Telefone:</strong> <span id="modalClienteTelefone"></span></p>
        <p><strong>Endereço:</strong> <span id="modalClienteEndereco"></span></p>
        <p><strong>Observações:</strong> <span id="modalObservacoes"></span></p>
      </div>
      <table class="order-items">
        <thead>
          <tr>
            <th>Produto</th>
            <th>Qtd</th>
            <th>Preço</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody id="modalOrderItems"></tbody>
      </table>
      <div class="order-total">
        <p><strong>Subtotal:</strong> R$ <span id="modalSubtotal"></span></p>
        <p><strong>Taxa de Entrega:</strong> R$ <span id="modalTaxaEntrega"></span></p>
        <p><strong>Total:</strong> R$ <span id="modalTotal"></span></p>
        <p><strong>Método de Pagamento:</strong> <span id="modalMetodoPagamento"></span></p>
      </div>
    </div>
  </div>
</div>

<script>
// URL da API - AJUSTE PARA SUA API REAL
const API_URL = 'http://localhost:3000';

// Função para buscar pedidos do MySQL (atualmente usando localStorage como fallback)
async function fetchOrders() {
  try {
    // Tenta buscar da API primeiro
    const response = await fetch(`${API_URL}/pedidos`);
    if (response.ok) {
      const pedidos = await response.json();
      return pedidos;
    }
  } catch (error) {
    console.warn('API não disponível, usando dados locais:', error);
  }
  
  // Fallback para localStorage se a API não estiver disponível
  try {
    const pedidos = JSON.parse(localStorage.getItem('carpdiem_pedidos')) || [];
    return pedidos;
  } catch (err) {
    console.error('Erro ao buscar pedidos:', err);
    return [];
  }
}

function getStatusBadge(status) {
  const statusMap = {
    'pendente': { text: 'Pendente', class: 'status-pending' },
    'concluído': { text: 'Concluído', class: 'status-completed' },
    'cancelado': { text: 'Cancelado', class: 'status-cancelled' }
  };
  
  const statusInfo = statusMap[status] || { text: status, class: 'status-pending' };
  return `<span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>`;
}

async function loadAdminData() {
  const pedidos = await fetchOrders();

  // Cards
  const today = new Date().toLocaleDateString('pt-BR');
  const pedidosHoje = pedidos.filter(p => p.data.includes(today));
  document.getElementById('todayOrders').textContent = pedidosHoje.length;
  
  const faturamento = pedidosHoje.reduce((sum, p) => sum + p.total, 0);
  document.getElementById('todayRevenue').textContent = `R$ ${faturamento.toFixed(2).replace('.',',')}`;
  
  const clientesHoje = new Set(pedidosHoje.map(p => p.cliente_telefone)).size;
  document.getElementById('todayCustomers').textContent = clientesHoje;

  // Tabela
  const tbody = document.querySelector('#recentOrders tbody');
  tbody.innerHTML = '';
  
  if(pedidos.length === 0){
    document.getElementById('emptyOrders').style.display = 'block';
  } else {
    document.getElementById('emptyOrders').style.display = 'none';
    // Mostrar os últimos 10 pedidos (mais recentes primeiro)
    const pedidosRecentes = pedidos.slice(-10).reverse();
    pedidosRecentes.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.numero_pedido}</td>
        <td>${p.cliente_nome}</td>
        <td>R$ ${p.total.toFixed(2).replace('.',',')}</td>
        <td>${getStatusBadge(p.status)}</td>
        <td>${p.data}</td>
        <td><button class="btn-table" onclick="viewOrder(${p.id})">Ver Detalhes</button></td>
      `;
      tbody.appendChild(tr);
    });
  }
}

async function viewOrder(id) {
  const pedidos = await fetchOrders();
  const pedido = pedidos.find(p => p.id === id);
  
  if (!pedido) return;
  
  document.getElementById('modalClienteNome').textContent = pedido.cliente_nome;
  document.getElementById('modalClienteTelefone').textContent = pedido.cliente_telefone;
  document.getElementById('modalClienteEndereco').textContent = pedido.cliente_endereco;
  document.getElementById('modalObservacoes').textContent = pedido.observacoes || 'Nenhuma';
  
  const itemsTbody = document.getElementById('modalOrderItems');
  itemsTbody.innerHTML = '';
  
  pedido.items.forEach(item => {
    const tr = document.createElement('tr');
    const totalItem = item.preco * item.quantidade;
    tr.innerHTML = `
      <td>${item.nome}</td>
      <td>${item.quantidade}</td>
      <td>R$ ${item.preco.toFixed(2).replace('.',',')}</td>
      <td>R$ ${totalItem.toFixed(2).replace('.',',')}</td>
    `;
    itemsTbody.appendChild(tr);
  });
  
  document.getElementById('modalSubtotal').textContent = pedido.subtotal.toFixed(2).replace('.',',');
  document.getElementById('modalTaxaEntrega').textContent = pedido.taxa_entrega.toFixed(2).replace('.',',');
  document.getElementById('modalTotal').textContent = pedido.total.toFixed(2).replace('.',',');
  
  const metodosPagamento = {
    'pix': 'PIX',
    'dinheiro': 'Dinheiro',
    'cartao': 'Cartão'
  };
  
  document.getElementById('modalMetodoPagamento').textContent = metodosPagamento[pedido.metodo_pagamento] || pedido.metodo_pagamento;
  
  // Mostrar modal
  document.getElementById('orderModal').style.display = 'flex';
}

// FUNÇÃO CORRIGIDA PARA EXPORTAR PDF
async function exportToPDF() {
  try {
    // Verificar se a biblioteca jsPDF está disponível
    if (typeof window.jspdf === 'undefined') {
      alert('Biblioteca jsPDF não carregada. Tente novamente.');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const margin = 15;
    let y = margin;

    // Título
    doc.setFontSize(20);
    doc.setTextColor(0, 0, 0);
    doc.text('Relatório de Pedidos - Carpe Diem', margin, y);
    y += 10;

    // Data de geração
    doc.setFontSize(12);
    doc.setTextColor(100, 100, 100);
    doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, margin, y);
    y += 15;

    // Buscar pedidos
    const pedidos = await fetchOrders();
    
    if (pedidos.length === 0) {
      doc.setFontSize(14);
      doc.setTextColor(150, 150, 150);
      doc.text('Nenhum pedido encontrado', margin, y);
      doc.save(`relatorio-pedidos-vazio-${new Date().toISOString().split('T')[0]}.pdf`);
      return;
    }

    // Estatísticas
    const today = new Date().toLocaleDateString('pt-BR');
    const pedidosHoje = pedidos.filter(p => p.data.includes(today));
    const faturamentoHoje = pedidosHoje.reduce((sum, p) => sum + p.total, 0);
    const clientesHoje = new Set(pedidosHoje.map(p => p.cliente_telefone)).size;

    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.text(`Pedidos Hoje: ${pedidosHoje.length}`, margin, y);
    y += 6;
    doc.text(`Faturamento Hoje: R$ ${faturamentoHoje.toFixed(2)}`, margin, y);
    y += 6;
    doc.text(`Clientes Hoje: ${clientesHoje}`, margin, y);
    y += 10;

    // Tabela de pedidos
    const tableColumn = ["Pedido", "Cliente", "Telefone", "Valor", "Status", "Data"];
    const tableRows = [];

    // Ordenar pedidos por data (mais recentes primeiro)
    const pedidosOrdenados = [...pedidos].sort((a, b) => new Date(b.timestamp || b.data) - new Date(a.timestamp || a.data));

    pedidosOrdenados.forEach(pedido => {
      const pedidoData = [
        pedido.numero_pedido,
        pedido.cliente_nome,
        pedido.cliente_telefone,
        `R$ ${pedido.total.toFixed(2)}`,
        pedido.status.charAt(0).toUpperCase() + pedido.status.slice(1),
        pedido.data
      ];
      tableRows.push(pedidoData);
    });

    // Gerar tabela
    doc.autoTable({
      startY: y,
      head: [tableColumn],
      body: tableRows,
      theme: 'grid',
      styles: { 
        fontSize: 9,
        cellPadding: 3,
        overflow: 'linebreak'
      },
      headStyles: { 
        fillColor: [255, 119, 0],
        textColor: [255, 255, 255],
        fontStyle: 'bold'
      },
      alternateRowStyles: {
        fillColor: [245, 245, 245]
      },
      margin: { top: y },
      didDrawPage: function (data) {
        // Rodapé em cada página
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text(
          `Página ${doc.internal.getNumberOfPages()} - Carpe Diem - ${new Date().getFullYear()}`,
          data.settings.margin.left,
          doc.internal.pageSize.height - 10
        );
      }
    });

    // Adicionar resumo final
    const finalY = doc.lastAutoTable.finalY + 10;
    
    if (finalY > 250) {
      doc.addPage();
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.text('Resumo Geral', margin, 20);
    } else {
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.text('Resumo Geral', margin, finalY);
    }

    const resumoY = finalY > 250 ? 30 : finalY + 10;

    doc.setFontSize(10);
    doc.text(`Total de Pedidos: ${pedidos.length}`, margin, resumoY);
    doc.text(`Faturamento Total: R$ ${pedidos.reduce((sum, p) => sum + p.total, 0).toFixed(2)}`, margin, resumoY + 6);
    
    // Estatísticas por status
    const statusCount = {};
    pedidos.forEach(pedido => {
      statusCount[pedido.status] = (statusCount[pedido.status] || 0) + 1;
    });
    
    doc.text(`Pedidos Pendentes: ${statusCount['pendente'] || 0}`, margin, resumoY + 12);
    doc.text(`Pedidos Concluídos: ${statusCount['concluído'] || 0}`, margin, resumoY + 18);
    doc.text(`Pedidos Cancelados: ${statusCount['cancelado'] || 0}`, margin, resumoY + 24);

    // Salvar o PDF
    const fileName = `relatorio-pedidos-${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
    
    // Feedback para o usuário
    console.log(`Relatório exportado com sucesso: ${fileName}`);
    
  } catch (error) {
    console.error('Erro ao exportar PDF:', error);
    alert('Erro ao exportar relatório. Verifique o console para mais detalhes.');
  }
}

// Event Listeners
document.getElementById('refreshData').addEventListener('click', loadAdminData);
document.getElementById('logoutBtn').addEventListener('click', () => {
  if(confirm('Tem certeza que deseja sair?')) {
    window.location.href = 'login.html';
  }
});

document.getElementById('closeModal').addEventListener('click', () => {
  document.getElementById('orderModal').style.display = 'none';
});

// Fechar modal ao clicar fora
window.addEventListener('click', (e) => {
  const modal = document.getElementById('orderModal');
  if (e.target === modal) {
    modal.style.display = 'none';
  }
});

// CORREÇÃO: Agora chama a função exportToPDF corretamente
document.getElementById('exportData').addEventListener('click', exportToPDF);

// Inicializar dados
document.addEventListener('DOMContentLoaded', loadAdminData);
</script>

</body>
</html>